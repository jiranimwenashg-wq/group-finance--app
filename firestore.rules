
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------
    // Helper Functions
    // ----------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Get the role of the current user in a group
    function userRole(groupId) {
      return get(
        /databases/$(database)/documents/groups/$(groupId)/users/$(request.auth.uid)
      ).data.role;
    }

    function isGroupMember(groupId) {
      return isSignedIn() &&
        exists(
          /databases/$(database)/documents/groups/$(groupId)/users/$(request.auth.uid)
        );
    }

    function isAdmin(groupId) {
      return isGroupMember(groupId) &&
        (userRole(groupId) == "admin" || userRole(groupId) == "owner");
    }

    function isOwnerOfGroup(groupId) {
      return isGroupMember(groupId) && userRole(groupId) == "owner";
    }

    // ----------------------
    //  Groups Collection
    // ----------------------

    match /groups/{groupId} {
      allow get: if isGroupMember(groupId);
      allow list: if false;

      // Only signed-in user may create a group; they become owner
      allow create: if isSignedIn()
                    && request.resource.data.id == groupId
                    && request.resource.data.ownerId == request.auth.uid;

      // Only owner or admin can update group
      allow update: if isAdmin(groupId)
                    && request.resource.data.id == groupId;

      allow delete: if false; // Disable unless you want owner-only delete
    }

    // -------------------------------
    //  /groups/{groupId}/users/{userId}
    // -------------------------------
    match /groups/{groupId}/users/{userId} {

      allow get: if isOwner(userId);
      allow list: if false;

      // User creates their own membership
      allow create: if isOwner(userId)
                    && request.resource.data.groupId == groupId
                    && request.resource.data.id == userId
                    && request.resource.data.role == "member";

      // UPDATE RULE:  
      // Only owner of the group may change roles.
      // User may update their own name, avatar, etc.
      allow update: if (
                      // Self-update (non-role fields only)
                      isOwner(userId)
                      && request.resource.data.role == resource.data.role
                    )
                    ||
                    (
                      // Owner updating roles
                      isOwnerOfGroup(groupId)
                    );

      // A user may delete their own membership
      allow delete: if isOwner(userId);
    }

    // -----------------------------
    // Generic Group Member Collections
    // -----------------------------

    match /groups/{groupId}/transactions/{docId} {
      allow read, list: if isGroupMember(groupId);
      allow write: if isGroupMember(groupId)
                   && request.resource.data.groupId == groupId;
    }
    
    match /groups/{groupId}/members/{memberId} {
      allow read, list: if isGroupMember(groupId);
      allow create, update: if isGroupMember(groupId) && request.resource.data.groupId == groupId;
      allow delete: if isGroupMember(groupId);
    }

    match /groups/{groupId}/constitutions/{docId} {
      allow read, list: if isGroupMember(groupId);
      allow write: if isGroupMember(groupId)
                   && request.resource.data.groupId == groupId;
    }

    match /groups/{groupId}/savingsSchedules/{docId} {
      allow read, list: if isGroupMember(groupId);
      allow write: if isGroupMember(groupId)
                   && request.resource.data.groupId == groupId;
    }
    
    match /groups/{groupId}/loans/{docId} {
      allow read, list: if isGroupMember(groupId);
      allow write: if isGroupMember(groupId)
                   && request.resource.data.groupId == groupId;
    }

    // ------------------------------
    // Insurance Policies + Payments
    // ------------------------------
    match /groups/{groupId}/insurancePolicies/{insurancePolicyId} {
      allow read, list: if isGroupMember(groupId);
      allow write: if isGroupMember(groupId)
                   && request.resource.data.groupId == groupId;

      // Payments subcollection
      match /payments/{paymentId} {
        allow read, list: if isGroupMember(groupId);
        allow write: if isGroupMember(groupId)
                     && request.resource.data.groupId == groupId;
      }
    }
  }
}
